<!DOCTYPE html>
<html>
<head>
    <title>React CRUD - Quản lý người dùng của Thành An</title>
    
    <script src='https://unpkg.com/react@18/umd/react.development.js'></script>
    <script src='https://unpkg.com/react-dom@18/umd/react-dom.development.js'></script>
    <script src='https://unpkg.com/@babel/standalone/babel.min.js'></script>
</head>

<body>

    <div id="root"></div>

    <script type="text/babel">

    const SearchForm = ({onChangeValue}) => {
        return (
            <input type="text" placeholder="Tìm Username" onChange={(e) => onChangeValue(e.target.value)}/>
        )
    }
    
    function AddUser({ onAdd }) {
        const [adding, setAdding] = React.useState(false); 
            
        // State để lưu trữ dữ liệu của người dùng mới
        const [user, setUser] = React.useState({ 
            name: "", username: "", email: "",
            address: { street: "", suite: "", city: "" }, 
            phone: "", website: ""
        });

        // Hàm xử lý khi gõ vào các ô input
        const handleChange = (e) => {
            const { id, value } = e.target;
            
            if (["street", "suite", "city"].includes(id)) {
                setUser((prevUser) => ({
                    ...prevUser,
                    address: {
                        ...prevUser.address, 
                    }
                })); 
            } else {
                setUser((prevUser) => ({
                    ...prevUser,
                    [id]: value
                })); 
            }
        }

        const handleAdd = () => {
            if (user.name === "" || user.username === "") { 
                alert("Vui lòng nhập Name và Username!");
                return;
            }
            
            // Nâng state lên App (gửi user mới lên component cha) [cite: 137]
            onAdd(user);
            
            // Reset form và ẩn đi
            setUser({ name: "", username: "", email: "", address: { street: "", suite: "", city: "" }, phone: "", website: "" }); 
            setAdding(false);
        };

        return (
            <div>
                <button onClick={() => setAdding(true)}>Thêm người dùng mới</button> 
                
                {/* Hiển thị form khi adding === true */}
                {adding && (
                    <div style={{ border: '1px solid #ccc', padding: '10px', marginTop: '10px' }}>
                        <h4>Thêm người dùng</h4> 
                        <label>Name: </label>
                        <input id="name" type="text" value={user.name} onChange={handleChange} />
                        <br />
                        <label>Username: </label>
                        <input id="username" type="text" value={user.username} onChange={handleChange} />
                        <br />
                        <label>Email: </label>
                        <input id="email" type="text" value={user.email} onChange={handleChange} />
                        <br />
                        <label>City: </label>
                        <input id="city" type="text" value={user.address.city} onChange={handleChange} />
                        <br />
                        <button onClick={handleAdd}>Lưu</button>
                        <button onClick={() => setAdding(false)}>Hủy</button>
                    </div>
                )}
            </div>
        );    
    }    

    function ResultTable({ keyword, user, onAdded }) {
        const [users, setUsers] = React.useState([]);
        // State kiểm soát trạng thái loading
        const [loading, setLoading] = React.useState(true); 
        // State lưu thông tin user đang được sửa
        const [editing, setEditing] = React.useState(null);

        React.useEffect(() => {
            fetch("https://jsonplaceholder.typicode.com/users")
                    .then(res => res.json())
                    .then(data => {
                        setUsers(data);
                        setLoading(false); 
                    })
        }, [])
        // [] là chỉ run khi components được mount (tải lần 1)
        
        React.useEffect(() => {
            if (user) { // Nếu có user mới được truyền từ App thì thêm user mới vào danh sách
                setUsers((prev) => [...prev, { ...user, id: prev.length + 1 }]); 
                onAdded(); // Báo cho App biết là đã thêm xong
            }
        }, [user]);

        const filteredUsers = users.filter(
            (u) =>
                u.name.toLowerCase().includes(keyword.toLowerCase()) ||
                u.username.toLowerCase().includes(keyword.toLowerCase()) 
        );

        // 1. Khi nhấn nút "Sửa"
        function editUser(userToEdit) {
            setEditing({ 
                ...userToEdit, 
                address: { ...userToEdit.address } 
            }); 
        }
        
        // 2. Khi gõ vào form Sửa
        function handleEditChange(e) {
            const { id, value } = e.target;
            
            // Tương tự AddUser, xử lý nested state 'address'
            if (["street", "suite", "city"].includes(id)) {
                setEditing((prev) => ({
                    ...prev,
                    address: { ...prev.address, [id]: value }
                }));
            } else {
                setEditing((prev) => ({ ...prev, [id]: value }));
            }
        }
        // 3. Khi nhấn nút "Lưu" (sau khi sửa)
        function saveUser() {
            // Nếu id trùng, thay thế bằng user trong state 'editing' 
            setUsers(prev => 
                prev.map(u => (u.id === editing.id ? editing : u))
            ); 
            setEditing(null); // Đóng form Sửa 
        }

        if (loading) {
            return <div>Loading...</div>;
        }


        return (
            <div>       
                {editing && (
                    <div style={{ border: '1px solid #00f', padding: '10px', margin: '10px 0' }}>
                        <h4>Chỉnh sửa: {editing.name}</h4>
                        <label>Name: </label>
                        <input id="name" type="text" value={editing.name} onChange={handleEditChange} /> 
                        <br />
                        <label>Username: </label>
                        <input id="username" type="text" value={editing.username} onChange={handleEditChange} />
                        <br />
                        <label>Email: </label>
                        <input id="email" type="text" value={editing.email} onChange={handleEditChange} />
                        <br />
                        <label>City: </label>
                        <input id="city" type="text" value={editing.address.city} onChange={handleEditChange} />
                        <br />
                        <button onClick={saveUser}>Lưu thay đổi</button>
                        <button onClick={() => setEditing(null)}>Hủy</button>
                    </div>
                )}

                <table border="1" width="100%">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Username</th>
                            <th>Email</th>
                            <th>City</th>
                            <th>Hành động</th>
                        </tr>
                    </thead>
                    <tbody>
                        {filteredUsers.map((u) => ( 
                            <tr key={u.id}> 
                                <td>{u.id}</td> 
                                <td>{u.name}</td> 
                                <td>{u.username}</td> 
                                <td>{u.email}</td> 
                                <td>{u.address.city}</td> 
                                <td>
                                    <button onClick={() => editUser(u)}>Sửa</button> 
                                    <button>Xóa</button> 
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        );
    }

    // App component
    function App() {
        // kw: lưu từ khóa tìm kiếm
        const [kw, setKeyword] = React.useState(""); 
        // newUser: lưu người dùng mới được thêm từ Form
        const [newUser, setNewUser] = React.useState(null); 

        return (
            <div>
                <h1>Quản lý người dùng</h1>
                
                {/* Truyền Props */}
                <SearchForm onChangeValue={setKeyword} />
                
                {/* Truyền Props */}
                <AddUser onAdd={setNewUser} />
                
                {/* Truyền Props */}
                <ResultTable
                    keyword={kw} 
                    user={newUser} 
                    onAdded={() => setNewUser(null)} 
                />
            </div>
        );
    }

    // 5. Render 
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);

</script>

</body>
</html>